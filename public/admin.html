<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kent Invest — Admin</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg admin-body">
  <header class="admin-header">
    <div class="admin-brand">
      <img src="/assets/Kent_Invest_Logo.png" class="brandlogo" alt="Kent Invest" />
      <div>
        <h1>KI – Live Trading Sim Admin</h1>
        <p class="muted">Control rounds, monitor autonomous desks, and follow the tape.</p>
      </div>
    </div>
    <div class="admin-header-actions">
      <button id="reloadBotsBtn" class="secondary">Reload Default Bots</button>
      <button id="applyBotConfigBtn">Apply Bot JSON</button>
    </div>
  </header>

  <main class="admin-grid">
    <section class="panel span-2">
      <div class="panel-header"><h2>Round Controls</h2></div>
      <div class="panel-body">
        <div class="control-row">
          <input id="productName" placeholder="Product name" />
          <input id="startPrice" type="number" inputmode="decimal" placeholder="Start price" />
        </div>
        <div class="control-row">
          <button id="startBtn">Start Round</button>
          <button id="pauseBtn">Pause / Resume</button>
          <button id="restartBtn" class="danger">Force Restart</button>
          <button id="modeToggleBtn" class="secondary">Switch to Volume Mode</button>
        </div>
        <p class="muted" id="modeStatus">Price mode: news-driven with noise shocks.</p>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header"><h2>News & Scenarios</h2></div>
      <div class="panel-body">
        <input id="newsInput" placeholder="Headline" />
        <div class="control-row">
          <input id="newsDelta" type="number" inputmode="decimal" placeholder="Δ Fair" />
          <input id="newsSentiment" type="number" step="0.1" placeholder="Sentiment" />
          <input id="newsIntensity" type="number" step="0.1" placeholder="Intensity" />
        </div>
        <div class="control-row">
          <button id="pushNewsBtn">Push News</button>
        </div>
        <div class="scenario-row">
          <button data-scenario="block-trade-day" class="secondary scenario-btn">Block Trade Day</button>
          <button data-scenario="data-drop" class="secondary scenario-btn">Data Drop</button>
        </div>
      </div>
    </section>

    <section class="panel span-2">
      <div class="panel-header"><h2>Live Price</h2></div>
      <div class="panel-body">
        <div class="price-stats">
          <div>
            <span class="label">Last</span>
            <div id="adminLastPrice" class="price-large">–</div>
          </div>
          <div>
            <span class="label">Fair</span>
            <div id="adminFairPrice" class="price-medium">–</div>
          </div>
        </div>
        <div class="chart-wrap">
          <canvas id="adminChart"></canvas>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header"><h2>Order Book</h2></div>
      <div class="panel-body">
        <div class="book-meta">
          <span id="adminBookSpread">Spread: —</span>
          <span id="adminBookMode" class="pill pill-mode">—</span>
        </div>
        <div class="orderbook" id="adminBook"></div>
      </div>
    </section>

    <section class="panel span-2">
      <div class="panel-header">
        <h2>Autonomous Desks</h2>
        <div class="panel-actions">
          <label class="muted" for="botJson">Paste config JSON</label>
        </div>
      </div>
      <div class="panel-body bot-panel">
        <table id="botTable">
          <thead>
            <tr><th>Bot</th><th>Type</th><th>Status</th><th>Inventory</th><th>PnL</th><th>Cancel/Fill</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <textarea id="botJson" placeholder='[ { "botType": "MM-Core", ... } ]'></textarea>
      </div>
    </section>

    <section class="panel" id="botDetailPanel">
      <div class="panel-header"><h2>Bot Detail</h2></div>
      <div class="panel-body" id="botDetailBody">
        <p class="muted">Select a bot to inspect parameters, risk, and recent decisions.</p>
      </div>
    </section>

    <section class="panel span-3">
      <div class="panel-header"><h2>Players</h2></div>
      <div class="panel-body">
        <table id="leaderboard">
          <thead><tr><th>Name</th><th>Position</th><th>PnL</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket     = io();
    const startBtn   = document.getElementById('startBtn');
    const pauseBtn   = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');
    const pushBtn    = document.getElementById('pushNewsBtn');
    const modeBtn    = document.getElementById('modeToggleBtn');
    const tbody      = document.querySelector('#leaderboard tbody');
    const modeStatus = document.getElementById('modeStatus');
    const lastLbl    = document.getElementById('adminLastPrice');
    const fairLbl    = document.getElementById('adminFairPrice');
    const chartCanvas= document.getElementById('adminChart');
    const chartCtx   = chartCanvas?.getContext('2d');
    const adminBook  = document.getElementById('adminBook');
    const adminSpread= document.getElementById('adminBookSpread');
    const adminMode  = document.getElementById('adminBookMode');
    const reloadBotsBtn = document.getElementById('reloadBotsBtn');
    const applyBotConfigBtn = document.getElementById('applyBotConfigBtn');
    const botTableBody = document.querySelector('#botTable tbody');
    const botDetailBody = document.getElementById('botDetailBody');
    const botJsonInput = document.getElementById('botJson');
    const scenarioButtons = document.querySelectorAll('.scenario-btn');

    let currentMode = 'news';
    let pricePoints = [];
    let yLo = null, yHi = null;
    let bookSnapshot = null;
    let botSummary = [];
    let selectedBotId = null;

    function resizeCanvas(){
      if (!chartCanvas) return;
      const wrap = chartCanvas.parentElement;
      const bb = wrap.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
      const w = Math.max(280, Math.floor(bb.width));
      const h = Math.max(180, Math.floor(w*0.45));
      chartCanvas.width = Math.floor(w*dpr);
      chartCanvas.height = Math.floor(h*dpr);
      chartCanvas.style.width = w+'px';
      chartCanvas.style.height = h+'px';
      chartCtx?.setTransform(dpr,0,0,dpr,0,0);
      scheduleDraw();
    }

    function describeMode(mode){
      if(mode==='orderflow'){
        return 'Price mode: volume-driven impact from players & bots.';
      }
      return 'Price mode: news-driven drift with stochastic noise.';
    }

    function updateModeUi(mode){
      currentMode = mode;
      if (modeBtn) {
        modeBtn.textContent = mode === 'orderflow' ? 'Switch to News Mode' : 'Switch to Volume Mode';
      }
      if (modeStatus) modeStatus.textContent = describeMode(mode);
      if (adminMode) {
        adminMode.textContent = `${mode === 'orderflow' ? 'Volume' : 'News'} Mode`;
        adminMode.dataset.mode = mode;
      }
    }

    function formatExposure(value){
      const num = Number(value || 0);
      const abs = Math.abs(num);
      if (!Number.isFinite(num) || abs < 1e-4) return '0';
      if (abs >= 100) return num.toFixed(0);
      if (abs >= 10) return num.toFixed(1);
      if (abs >= 1) return num.toFixed(2);
      return num.toFixed(3);
    }

    function formatVolume(value){
      const num = Number(value || 0);
      if (!Number.isFinite(num)) return '0.00';
      if (Math.abs(num) >= 100) return num.toFixed(0);
      if (Math.abs(num) >= 10) return num.toFixed(1);
      return num.toFixed(2);
    }

    function renderAdminBook(book){
      if (!adminBook) return;
      bookSnapshot = book;
      if (!book || ((!book.bids || !book.bids.length) && (!book.asks || !book.asks.length))) {
        adminBook.innerHTML = '<div class="book-empty muted">No resting liquidity</div>';
        if (adminSpread) adminSpread.textContent = 'Spread: —';
        return;
      }

      const asks = Array.isArray(book.asks) ? book.asks : [];
      const bids = Array.isArray(book.bids) ? book.bids : [];
      const volumes = [...asks, ...bids].map(level => Number(level?.size || 0));
      const maxVol = Math.max(1, ...volumes, 1);
      const rows = [];

      for (let i = asks.length - 1; i >= 0; i -= 1) {
        const level = asks[i];
        const vol = Number(level.size || 0);
        const cum = Number(level.cumulative || 0);
        const width = Math.min(100, (vol / maxVol) * 100);
        const best = level.price === book.bestAsk;
        rows.push(`<div class="orderbook-row ask${best ? ' best' : ''}" style="--bar:${width.toFixed(1)}%"><span>${formatVolume(vol)}</span><span>${Number(level.price).toFixed(2)}</span><span>${formatVolume(cum)}</span></div>`);
      }

      const mid = Number(book.lastPrice ?? book.midPrice ?? 0).toFixed(2);
      rows.push(`<div class="orderbook-row mid"><span></span><span>${mid}</span><span></span></div>`);

      for (let i = 0; i < bids.length; i += 1) {
        const level = bids[i];
        const vol = Number(level.size || 0);
        const cum = Number(level.cumulative || 0);
        const width = Math.min(100, (vol / maxVol) * 100);
        const best = level.price === book.bestBid;
        rows.push(`<div class="orderbook-row bid${best ? ' best' : ''}" style="--bar:${width.toFixed(1)}%"><span>${formatVolume(vol)}</span><span>${Number(level.price).toFixed(2)}</span><span>${formatVolume(cum)}</span></div>`);
      }

      adminBook.innerHTML = rows.join('');
      requestAnimationFrame(() => {
        const target = Math.max(0, (adminBook.scrollHeight - adminBook.clientHeight) / 2);
        adminBook.scrollTop = target;
      });

      if (adminSpread) {
        const spread = Number(book.spread);
        adminSpread.textContent = Number.isFinite(spread) && spread > 0
          ? `Spread: ${spread.toFixed(2)}`
          : 'Spread: —';
      }
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatPnL(value){
      const num = Number(value || 0);
      if (!Number.isFinite(num)) return '0.00';
      const prefix = num >= 0 ? '' : '-';
      const abs = Math.abs(num);
      if (abs >= 1000) return `${prefix}${(abs/1000).toFixed(1)}k`;
      if (abs >= 100) return `${prefix}${abs.toFixed(0)}`;
      return `${prefix}${abs.toFixed(2)}`;
    }

    function updateBotSelection(){
      if (!botTableBody) return;
      const rows = botTableBody.querySelectorAll('tr');
      rows.forEach((row) => {
        if (row.dataset.botId === selectedBotId) row.classList.add('active');
        else row.classList.remove('active');
      });
    }

    function renderBots(summary){
      if (!botTableBody) return;
      botSummary = Array.isArray(summary?.bots) ? summary.bots : [];
      botTableBody.innerHTML = '';
      botSummary.forEach((bot) => {
        const tr = document.createElement('tr');
        tr.dataset.botId = bot.id;
        tr.innerHTML = `
          <td>${bot.name || bot.id}</td>
          <td>${bot.type || ''}</td>
          <td>${bot.enabled === false ? 'Paused' : bot.status || 'Active'}</td>
          <td>${formatExposure(bot.inventory ?? 0)}</td>
          <td>${formatPnL(bot.pnl)}</td>
          <td>${(bot.metrics?.cancelToFill ?? 0).toFixed(2)}</td>`;
        tr.addEventListener('click', () => {
          selectedBotId = bot.id;
          updateBotSelection();
          loadBotDetail(bot.id);
        });
        botTableBody.appendChild(tr);
      });
      updateBotSelection();
    }

    function renderBotDetailView(bot){
      if (!botDetailBody) return;
      if (!bot) {
        botDetailBody.innerHTML = '<p class="muted">Select a bot to inspect parameters, risk, and recent decisions.</p>';
        return;
      }
      const metrics = bot.metrics || {};
      const log = Array.isArray(bot.decisionLog) ? bot.decisionLog.slice(-12).reverse() : [];
      const risk = bot.config?.risk || {};
      const latency = bot.latency || {};
      botDetailBody.innerHTML = `
        <div class="bot-detail-meta">
          <div><span class="label">Type</span><p>${bot.type || '—'}</p></div>
          <div><span class="label">Status</span><p>${bot.enabled === false ? 'Paused' : bot.status || 'Active'}</p></div>
          <div><span class="label">Inventory</span><p>${formatExposure(bot.inventory ?? 0)}</p></div>
          <div><span class="label">PnL</span><p>${formatPnL(bot.pnl)}</p></div>
        </div>
        <div class="bot-detail-grid">
          <div><span class="label">Latency</span><p>${(latency.mean ?? '—')}ms ± ${(latency.jitter ?? '—')}ms</p></div>
          <div><span class="label">Cancel / Fill</span><p>${(metrics.cancelToFill ?? 0).toFixed(2)}</p></div>
          <div><span class="label">Quote Life</span><p>${(metrics.avgQuoteLifeMs ?? 0).toFixed(0)}ms</p></div>
          <div><span class="label">Total Volume</span><p>${formatExposure(metrics.totalVolume ?? 0)}</p></div>
        </div>
        <div class="bot-detail-grid">
          <div><span class="label">Max Loss</span><p>${formatPnL(risk.maxLoss)}</p></div>
          <div><span class="label">Drawdown</span><p>${formatPnL(risk.maxDrawdown)}</p></div>
          <div><span class="label">Kill Switch</span><p>${risk.killSwitch ? 'Armed' : 'Off'}</p></div>
        </div>
        <div class="bot-detail-actions">
          <button id="toggleBotBtn" class="secondary">${bot.enabled === false ? 'Enable Bot' : 'Pause Bot'}</button>
        </div>
        <h3>Recent Decisions</h3>
        <ul class="bot-log">${log.map(item => `<li><span>${new Date(item.t).toLocaleTimeString()}</span><code>${escapeHtml(item.message || item.action || JSON.stringify(item))}</code></li>`).join('')}</ul>
      `;
      const toggleBtn = document.getElementById('toggleBotBtn');
      if (toggleBtn) {
        toggleBtn.onclick = async () => {
          try {
            await fetch(`/api/bots/${bot.id}/toggle`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabled: bot.enabled === false }),
            });
            fetchBotSummary();
            loadBotDetail(bot.id);
          } catch (err) {
            console.error('toggle failed', err);
          }
        };
      }
    }

    async function loadBotDetail(id){
      try {
        const res = await fetch(`/api/bots/${id}`);
        if (!res.ok) throw new Error('failed');
        const data = await res.json();
        renderBotDetailView(data.bot);
      } catch (err) {
        console.error('bot detail', err);
      }
    }

    async function fetchBotSummary(){
      try {
        const res = await fetch('/api/bots');
        if (!res.ok) throw new Error('failed');
        const data = await res.json();
        renderBots(data);
        if (selectedBotId) {
          const found = data.bots?.find((b) => b.id === selectedBotId);
          if (!found) {
            selectedBotId = null;
            renderBotDetailView(null);
          }
        }
      } catch (err) {
        console.error('fetch bots', err);
      }
    }

    startBtn.onclick = () => {
      const product = (document.getElementById('productName').value||'').trim() || 'Demo Asset';
      const startPrice = parseFloat(document.getElementById('startPrice').value) || 100;
      socket.emit('startGame', { startPrice, product });
    };
    pauseBtn.onclick = () => socket.emit('pauseGame');
    restartBtn.onclick = () => {
      if (confirm('Restart round? All players will need to re-join.')) socket.emit('restartGame');
    };
    modeBtn.onclick = () => {
      const next = currentMode === 'orderflow' ? 'news' : 'orderflow';
      socket.emit('setPriceMode', { mode: next });
    };
    pushBtn.onclick = () => {
      const text = document.getElementById('newsInput').value.trim();
      const deltaStr = (document.getElementById('newsDelta').value||'').trim();
      const sentimentStr = (document.getElementById('newsSentiment')?.value||'').trim();
      const intensityStr = (document.getElementById('newsIntensity')?.value||'').trim();
      const payload = {
        text,
        delta: parseFloat(deltaStr),
        sentiment: sentimentStr ? parseFloat(sentimentStr) : undefined,
        intensity: intensityStr ? parseFloat(intensityStr) : undefined,
      };
      socket.emit('pushNews', payload);
      document.getElementById('newsInput').value = '';
      document.getElementById('newsDelta').value = '';
      if (document.getElementById('newsSentiment')) document.getElementById('newsSentiment').value = '';
      if (document.getElementById('newsIntensity')) document.getElementById('newsIntensity').value = '';
    };

    if (reloadBotsBtn) {
      reloadBotsBtn.onclick = async () => {
        try {
          await fetch('/api/bots/reload', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
          fetchBotSummary();
          renderBotDetailView(null);
        } catch (err) {
          console.error('reload bots', err);
        }
      };
    }

    if (applyBotConfigBtn) {
      applyBotConfigBtn.onclick = async () => {
        if (!botJsonInput) return;
        const raw = botJsonInput.value.trim();
        if (!raw) return;
        try {
          const configs = JSON.parse(raw);
          await fetch('/api/bots/reload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ configs }),
          });
          botJsonInput.value = '';
          selectedBotId = null;
          renderBotDetailView(null);
          fetchBotSummary();
        } catch (err) {
          console.error('apply bot config', err);
          alert('Invalid JSON payload for bot configuration.');
        }
      };
    }

    scenarioButtons.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const scenario = btn.dataset.scenario;
        if (!scenario) return;
        try {
          await fetch(`/api/scenarios/${scenario}`, { method: 'POST' });
        } catch (err) {
          console.error('scenario trigger failed', err);
        }
      });
    });

    function drawChart(){
      if (!chartCtx || pricePoints.length < 2) { chartCtx?.clearRect(0,0,chartCanvas.width, chartCanvas.height); return; }
      const dpr = window.devicePixelRatio||1;
      const w = chartCanvas.width / dpr;
      const h = chartCanvas.height / dpr;
      chartCtx.clearRect(0,0,w,h);

      chartCtx.strokeStyle = 'rgba(255,255,255,.08)';
      chartCtx.lineWidth = 1;
      chartCtx.beginPath();
      for(let i=1;i<=3;i++){ const y=(h/4)*i; chartCtx.moveTo(0,y); chartCtx.lineTo(w,y); }
      chartCtx.stroke();

      const view = pricePoints.slice(-600);
      const rawLo = Math.min(...view);
      const rawHi = Math.max(...view);
      const pad = Math.max(0.25, (rawHi - rawLo) * 0.12);
      const tgtLo = rawLo - pad;
      const tgtHi = rawHi + pad;

      if (yLo === null || yHi === null) { yLo = tgtLo; yHi = tgtHi; }
      if (tgtLo < yLo) yLo = tgtLo; else yLo = yLo + (tgtLo - yLo) * 0.05;
      if (tgtHi > yHi) yHi = tgtHi; else yHi = yHi + (tgtHi - yHi) * 0.05;

      const X = i => (i/(view.length-1||1)) * w;
      const Y = p => h - ((p - yLo)/Math.max(1e-6,(yHi - yLo))) * h;

      chartCtx.strokeStyle = '#6da8ff';
      chartCtx.lineWidth = 2;
      chartCtx.beginPath();
      chartCtx.moveTo(0, Y(view[0]));
      for (let i=1;i<view.length;i++) chartCtx.lineTo(X(i), Y(view[i]));
      chartCtx.stroke();

      chartCtx.fillStyle = '#fff';
      chartCtx.beginPath();
      chartCtx.arc(X(view.length-1), Y(view[view.length-1]), 3, 0, Math.PI*2);
      chartCtx.fill();
    }

    function scheduleDraw(){
      if (scheduleDraw._p) return;
      scheduleDraw._p = true;
      requestAnimationFrame(()=>{ scheduleDraw._p = false; drawChart(); });
    }

    window.addEventListener('resize', () => {
      resizeCanvas();
      renderAdminBook(bookSnapshot);
    });
    resizeCanvas();
    updateModeUi('news');
    renderAdminBook(null);
    fetchBotSummary();

    socket.on('playerList', (rows) => {
      tbody.innerHTML = '';
      rows.sort((a,b)=> b.pnl - a.pnl).forEach(r=>{
        const tr = document.createElement('tr');
        const nameHtml = r.isBot ? `${r.name} <span class="pill pill-bot">BOT</span>` : r.name;
        const position = formatExposure(r.position ?? 0);
        const pnl = Number(r.pnl || 0).toFixed(2);
        tr.innerHTML = `<td>${nameHtml}</td><td>${position}</td><td>${pnl}</td>`;
        tbody.appendChild(tr);
      });
    });

    socket.on('priceMode', (mode)=>{
      updateModeUi(mode === 'orderflow' ? 'orderflow' : 'news');
    });

    socket.on('orderBook', (book)=>{
      renderAdminBook(book);
    });

    socket.on('priceUpdate', ({ price, fair })=>{
      if (typeof price === 'number') {
        pricePoints.push(price);
        if (pricePoints.length > 720) pricePoints = pricePoints.slice(-720);
        lastLbl.textContent = price.toFixed(2);
        scheduleDraw();
      }
      if (typeof fair === 'number') {
        fairLbl.textContent = fair.toFixed(2);
      }
    });

    socket.on('gameStarted', ({ priceMode, price, fairValue })=>{
      pricePoints = [];
      yLo = yHi = null;
      if (typeof price === 'number') {
        pricePoints.push(price);
        lastLbl.textContent = price.toFixed(2);
      } else if (typeof fairValue === 'number') {
        pricePoints.push(fairValue);
      }
      if (typeof fairValue === 'number') fairLbl.textContent = fairValue.toFixed(2);
      if (priceMode) updateModeUi(priceMode);
      scheduleDraw();
      renderAdminBook(null);
    });

    socket.on('gameReset', () => {
      pricePoints = [];
      yLo = yHi = null;
      lastLbl.textContent = '–';
      fairLbl.textContent = '–';
      updateModeUi('news');
      scheduleDraw();
      renderAdminBook(null);
    });

    socket.on('botSummary', (data) => {
      renderBots(data);
      if (selectedBotId) {
        const exists = data?.bots?.some((b) => b.id === selectedBotId);
        if (!exists) {
          selectedBotId = null;
          renderBotDetailView(null);
        }
      }
    });

    socket.on('botDecision', ({ botId, decision }) => {
      if (botId !== selectedBotId) return;
      const logList = botDetailBody?.querySelector('.bot-log');
      if (!logList) return;
      const li = document.createElement('li');
      const when = new Date(decision?.t || Date.now()).toLocaleTimeString();
      const message = decision?.message || decision?.action || JSON.stringify(decision);
      li.innerHTML = `<span>${when}</span><code>${escapeHtml(message)}</code>`;
      logList.prepend(li);
      while (logList.children.length > 12) logList.removeChild(logList.lastChild);
    });

    socket.on('botTelemetry', ({ botId }) => {
      if (botId !== selectedBotId) return;
      loadBotDetail(botId);
    });
  </script>
</body>
</html>
